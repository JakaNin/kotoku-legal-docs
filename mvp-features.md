# MVP機能仕様書

## 🎯 MVP期の目的

行動検証フェーズとして、「投稿→受諾→完了→レビュー」という一連の助け合い行動が実際に発生するかを検証する。完璧なアプリではなく、最小限の機能で行動発生を確認することが最優先。

---

## 📊 機能優先順位

### P0: 必須機能（Week 1-4）

これらがないとサービスとして成立しない核心機能

#### 1. ユーザー認証・プロフィール

| 項目         | 内容                                         |
| ------------ | -------------------------------------------- |
| 認証方式     | Google OAuth（Supabase Auth）                |
| 必須情報     | 名前、エリア（町丁目単位）、プロフィール写真 |
| セキュリティ | 実名制で信頼性確保、住所詳細は非公開         |

**実装要件:**

- [ ] Supabase Auth統合
- [ ] プロフィール登録フロー（初回ログイン時）
- [ ] エリア選択UI（都道府県→市区町村→町丁目）
- [ ] プロフィール編集機能

#### 2. 買い物依頼投稿

| 項目           | 内容                                                               |
| -------------- | ------------------------------------------------------------------ |
| 入力項目       | タイトル、商品リスト、各商品の上限価格、代替可否、希望受け取り日時 |
| バリデーション | 禁止品目チェック（酒類、医薬品、たばこ等）                         |
| 公開範囲       | 同一町丁目内のユーザーのみ閲覧可能                                 |

**実装要件:**

- [ ] 投稿フォームUI（複数商品追加可能）
- [ ] 禁止品目リストとクライアント側バリデーション
- [ ] 商品ごとの代替可否チェックボックス
- [ ] 画像添付機能（商品参考写真）

#### 3. タイムライン（依頼一覧）

| 項目     | 内容                               |
| -------- | ---------------------------------- |
| 表示内容 | 自分のエリアの未マッチング依頼一覧 |
| ソート   | 投稿日時降順（新しい順）           |
| フィルタ | 自分の投稿を除外するオプション     |

**実装要件:**

- [ ] カード型一覧表示（タイトル、商品数、謝礼、投稿者名、エリア）
- [ ] 詳細モーダル or 詳細ページ遷移
- [ ] リアルタイム更新（Supabase Realtime）
- [ ] 「ついでに買う」ボタン

#### 4. 受諾・マッチング

| 項目           | 内容                             |
| -------------- | -------------------------------- |
| 受諾アクション | 「ついでに買う」ボタンクリック   |
| 同時受諾制限   | 先着1名のみマッチング            |
| 通知           | 依頼者に通知（アプリ内＋メール） |

**実装要件:**

- [ ] 受諾ボタンとトランザクション制御（同時クリック対策）
- [ ] ステータス更新（posted → matched）
- [ ] 依頼者への通知送信
- [ ] マッチング後の詳細画面遷移

#### 5. チャット機能

| 項目           | 内容                                   |
| -------------- | -------------------------------------- |
| 用途           | 商品の詳細確認、受け渡し場所・時間調整 |
| 機能           | テキストメッセージ、画像送信           |
| リアルタイム性 | Supabase Realtimeで即時反映            |

**実装要件:**

- [ ] チャットUI（依頼ごとに1対1）
- [ ] メッセージ送受信機能
- [ ] 画像アップロード（棚写真送信用）
- [ ] 未読カウント表示

#### 6. 購入確認フロー（棚写真承認）

| 項目             | 内容                                           |
| ---------------- | ---------------------------------------------- |
| 代行者アクション | 店舗で商品棚を撮影してチャットで送信           |
| 依頼者アクション | 写真確認して「購入OK」または「別の商品に変更」 |
| スキップ         | 依頼者が事前承認済みの場合は省略可能           |

**実装要件:**

- [ ] 代行者側：棚写真撮影→送信ボタン
- [ ] 依頼者側：承認UI（OK/変更依頼ボタン）
- [ ] ステータス管理（matched → shopping → purchased）

#### 7. 受け渡し確認

| 項目             | 内容                                     |
| ---------------- | ---------------------------------------- |
| 代行者アクション | レシート写真アップロード、商品未開封確認 |
| 依頼者アクション | 商品受領後「受領OKボタン」押下           |
| 確定条件         | 受領OK押下 or 24時間経過で自動確定       |

**実装要件:**

- [ ] レシート写真アップロード機能
- [ ] 商品受領チェックリストUI
- [ ] 受領OKボタン（取引確定トリガー）
- [ ] 自動確定タイマー（24時間）
- [ ] レシート原本管理（依頼者が選択、詳細は[レシート管理方針](./implementation/receipt-management-policy.md)参照）

#### 8. レビュー・評価

| 項目       | 内容                         |
| ---------- | ---------------------------- |
| 評価内容   | 星評価（1-5）＋コメント      |
| 相互評価   | 依頼者→代行者、代行者→依頼者 |
| スコア反映 | プロフィールに平均評価を表示 |

**実装要件:**

- [ ] レビュー投稿フォーム（星評価＋テキスト）
- [ ] 相互評価促進UI
- [ ] 信頼スコア計算・表示

#### 9. 税務コンプライアンス

| 項目         | 内容                                      |
| ------------ | ----------------------------------------- |
| 年間収入集計 | 取引完了時に自動加算                      |
| 通知機能     | 5万円・20万円到達時に自動通知             |
| 取引レポート | 年間取引レポートのダウンロード（CSV/PDF） |
| 税務ガイド   | 確定申告ガイドページ                      |

**実装要件:**

- [ ] users テーブルに年間収入カラム追加
- [ ] 取引完了時の自動加算処理
- [ ] 5万円到達時の通知送信
- [ ] 20万円到達時の確定申告リマインダー（会社員向け）
- [ ] 年間取引レポート生成API（/api/tax-report）
- [ ] 税務ガイドページ作成
- [ ] 利用規約への税務申告条項追加

**法的根拠:**

- 所得税法第225条: 年間5万円超の支払いがある場合、支払調書提出義務
- 所得税法第121条: 給与所得者は給与以外の所得が年間20万円超で確定申告必要

#### 10. 報告機能（モデレーション）

| 項目        | 内容                                                 |
| ----------- | ---------------------------------------------------- |
| 報告対象    | ユーザー、依頼、メッセージ、受け渡し                 |
| 報告理由    | 禁止品目、ハラスメント、詐欺、不適切な内容、スパム等 |
| 運用方法    | Phase 1: Supabase Studioで手動モデレーション         |
| Phase 2予定 | 管理者ダッシュボード、BAN機能、自動制限              |

**実装要件（Phase 1 - MVP）:**

- [ ] reports テーブル作成
- [ ] 報告フォームUI（ユーザー、依頼、メッセージ、受け渡しから報告可能）
- [ ] 報告理由選択UI（禁止品目、ハラスメント、詐欺、不適切な内容、スパム、偽プロフィール、支払いトラブル、その他）
- [ ] 詳細説明入力（20文字以上必須）
- [ ] RLSポリシー（一般ユーザーは自分の報告のみ閲覧可能）
- [ ] users テーブルにBAN関連カラム追加（`role`, `is_banned`, `banned_at`, `ban_reason`, `banned_by`）

**Phase 1 運用方法:**

- 報告はデータベースに蓄積されるのみ
- 管理者はSupabase Studioで直接確認
- BAN等の対応は手動でSQLを実行

**Phase 2 実装予定（TODO）:**

- [ ] 管理者ダッシュボード（/admin）
- [ ] 報告一覧・詳細ページ
- [ ] BAN実行・解除UI
- [ ] BANユーザーの自動制限（RLSポリシーで投稿・マッチング不可）
- [ ] 報告ステータス管理（pending, reviewing, resolved, rejected）

**詳細設計:**

- [`tmp/moderation-system-design.md`](moderation-system-design.md) - 報告・モデレーション機能の詳細設計

---

### P1: 重要機能（Week 5-6）

MVPとして望ましいが、行動検証の絶対条件ではない

#### 9. 謝礼決済（Stripe PaymentLink）

| 項目     | 内容                                             |
| -------- | ------------------------------------------------ |
| 金額     | 固定500円                                        |
| 支払方法 | 依頼者がStripe PaymentLink経由で代行者に直接送金 |
| 代替手段 | MVP期は現金払いも許容                            |

**実装要件:**

- [ ] Stripe PaymentLink生成機能
- [ ] 支払完了Webhook受信
- [ ] 決済ステータス管理

#### 10. 通知センター

| 項目       | 内容                                       |
| ---------- | ------------------------------------------ |
| 通知タイプ | マッチング、メッセージ受信、ステータス変更 |
| 表示方式   | ベル型アイコン＋通知一覧                   |

**実装要件:**

- [ ] 通知テーブル設計
- [ ] 通知一覧UI
- [ ] 既読管理

#### 11. マイページ

| 項目     | 内容                                 |
| -------- | ------------------------------------ |
| 表示内容 | 自分の依頼履歴、受諾履歴、評価スコア |
| 機能     | プロフィール編集、取引履歴確認       |

**実装要件:**

- [ ] 依頼履歴タブ
- [ ] 受諾履歴タブ
- [ ] 統計情報（完了数、評価平均）

---

### P2: 将来機能（Week 7-8以降）

βリリースまたはスケール期に実装

#### 12. LINE連携

- LINE Messaging API統合
- LINE通知配信

#### 13. 手数料徴収

- 10%手数料モデル実装
- Stripe Connect導入

#### 14. 通報・ブロック機能（管理者UI・自動制限）

⚠️ **Phase 1で報告機能（P0-10）は実装済み**（手動モデレーション）

**Phase 2で追加:**

- 管理者ダッシュボード（報告一覧・詳細）
- BAN実行・解除UI
- BANユーザーの自動制限（RLSポリシー）
- ブロックリスト管理（ユーザー間のブロック機能）

#### 15. 検索・フィルタ

- 商品カテゴリ検索
- 日時フィルタ

---

## 🚫 禁止品目リスト（P0実装必須）

以下の商品は投稿時にバリデーションでブロック：

| カテゴリ   | 具体例                       |
| ---------- | ---------------------------- |
| 酒類       | ビール、日本酒、ワイン等     |
| 医薬品     | 処方薬、市販薬               |
| たばこ     | 紙巻きたばこ、加熱式たばこ   |
| 化粧品     | スキンケア、メイクアップ用品 |
| 生鮮食品   | 肉、魚、野菜（品質保証困難） |
| 現金・金券 | 商品券、プリペイドカード     |
| 高額商品   | 5,000円以上の商品            |
| 動植物     | ペット、観葉植物             |

**実装方式:**

- 禁止キーワードリストでクライアント側チェック
- Supabase Edge Functionsでサーバー側ダブルチェック

---

## 🔄 ユーザーフローとステータス遷移

```
[依頼者] 投稿 → posted
         ↓
[代行者] 受諾 → matched
         ↓
[代行者] 買い物開始 → shopping
         ↓
[代行者] 棚写真送信 → awaiting_approval
         ↓
[依頼者] 購入承認 → purchased
         ↓
[代行者] 商品受け渡し → delivering
         ↓
[依頼者] 受領OK → completed
         ↓
[両者]   レビュー投稿 → reviewed
```

---

## 📱 画面一覧（P0スコープ）

| #   | 画面名           | 説明                 |
| --- | ---------------- | -------------------- |
| 1   | ログイン         | Google OAuth         |
| 2   | プロフィール登録 | 初回ログイン時       |
| 3   | タイムライン     | 依頼一覧             |
| 4   | 依頼詳細         | 商品詳細・受諾ボタン |
| 5   | 投稿フォーム     | 新規依頼作成         |
| 6   | チャット         | 1対1メッセージ       |
| 7   | 受け渡し画面     | レシート・商品確認   |
| 8   | レビュー投稿     | 評価入力             |
| 9   | マイページ       | 履歴・プロフィール   |
| 10  | 報告フォーム     | 問題報告             |

---

## 💡 MVP成功指標

| 指標                 | 目標値   |
| -------------------- | -------- |
| テストユーザー登録数 | 10名以上 |
| 依頼投稿数           | 5件以上  |
| マッチング成立数     | 2件以上  |
| 完了取引数           | 2件以上  |
| レビュー投稿率       | 80%以上  |
| 平均評価スコア       | 4.0以上  |

---

## 次ステップ

- [アーキテクチャ設計書](./architecture.md)を参照
- [データモデル設計書](./data-model.md)を参照
- [実装ロードマップ](./implementation-roadmap.md)を参照
